#{extends 'login.html' /}

<!-- datepickerにtimepickerアドオン -->
<!-- 
<script type="text/javascript" src="http://trentrichardson.com/examples/timepicker/js/jquery-ui-timepicker-addon.js"></script>
 -->
<script type="text/javascript" src="@{'/public/javascripts/jquery-ui-timepicker-addon.js'}"></script>

<script type="text/javascript" src="@{'/public/javascripts/jquery.datepicker.js'}" ></script>
<script type="text/javascript" src="@{'/public/javascripts/confirm.js'}" ></script>
<script type="text/javascript" src="@{'/public/javascripts/dateformat.js'}" ></script>
<script type="text/javascript" src="@{'/public/javascripts/autoNumeric-1.7.5.js'}" ></script>

<script type="text/javascript">
<!--
//「収支種類」ごとの「項目」のサブカテゴリー
var subcategoryItem = {
  #{list items:models.BalanceTypeMst.find("order by id").fetch(), as:'bType'}
    #{if bType.balance_type_name==messages.get('BalanceType.in') ||
         bType.balance_type_name==messages.get('BalanceType.out')}
      "${bType.id}":[
          #{list items:models.ItemMst.find("ha_user = '${haUser.id}' and balance_type_mst = " + bType.id + " order by id").fetch(), as:'item'}
          {
            "key":"${item.id}",
            "value":"${item.item_name}"
          },
          #{/list}
      ],
    #{/if}
  #{/list}
}
//「収支種類」ごとの「取扱(実際)」のサブカテゴリー
var subcategoryHandling = {
  #{list items:models.BalanceTypeMst.find("order by id").fetch(), as:'bType'}
    #{if bType.balance_type_name==messages.get('BalanceType.in') ||
         bType.balance_type_name==messages.get('BalanceType.out')}
      "${bType.id}":[
//          {
//            "key":"0",
//            "value":"&{'views.common.combo.required.long'}"
//          },
          #{list items:models.HandlingMst.find("ha_user = '${haUser.id}' and invalidity_flg = false order by handling_type_mst.handling_type_order, order_seq").fetch(), as:'handling'}
          {
            "key":"${handling.id}",
            "value":"${handling.handling_name}"
          },
          #{/list}
      ],
    #{/if}
    #{if bType.balance_type_name==messages.get('BalanceType.bank_in') ||
         bType.balance_type_name==messages.get('BalanceType.bank_out')}
      "${bType.id}":[
//          {
//            "key":"0",
//            "value":"&{'views.common.combo.required.long'}"
//          },
          #{list items:models.HandlingMst.find("ha_user = '${haUser.id}' and invalidity_flg = false and handling_type_mst.handling_type_name IN('" + messages.get('HandlingType.bank') + "','" + messages.get('HandlingType.emoney') + "') order by handling_type_mst.handling_type_order, order_seq").fetch(), as:'handling'}
          {
            "key":"${handling.id}",
            "value":"${handling.handling_name}"
          },
          #{/list}
      ],
    #{/if}
  #{/list}
}
//起動時の「項目」・「取扱(My貯金)」の入力可・不可
jQuery(document).ready(function() {
	//「収支種類」が収入・支出の時は「項目」は選択可能
	if(jQuery('#balance_type_mst').children(':selected').text()=="&{'BalanceType.in'}" ||
			jQuery('#balance_type_mst').children(':selected').text()=="&{'BalanceType.out'}") {
//		jQuery('#item_mst_lbl').css("display","inline");
//		jQuery('#item_mst').css("display","inline");
		jQuery('#item_mst_lbl').removeAttr("disabled");
		jQuery('#item_mst').removeAttr("disabled");
	} else {
//		jQuery('#item_mst_lbl').css("display","none");
//		jQuery('#item_mst').css("display","none");
		jQuery('#item_mst_lbl').attr("disabled", "disabled");
		jQuery('#item_mst').attr("disabled", "disabled");
		//「収支種類」が口座預入・口座引出の時は「取扱(My貯金)」は選択不可
		if(jQuery('#balance_type_mst').children(':selected').text()=="&{'BalanceType.bank_in'}" ||
				jQuery('#balance_type_mst').children(':selected').text()=="&{'BalanceType.bank_out'}") {
			jQuery('#ideal_deposit_mst_lbl').attr("disabled", "disabled");
			jQuery('#ideal_deposit_mst').attr("disabled", "disabled");
		} else {
			jQuery('#ideal_deposit_mst_lbl').removeAttr("disabled");
			jQuery('#ideal_deposit_mst').removeAttr("disabled");
		}
	}
});
//起動時の「取扱(実際)」・「引落日」の入力可・不可
jQuery(document).ready(function() {
	//「収支種類」が収入・支出・口座預入・口座引出の時は「取扱(実際)」・「引落日」は選択可能
	if(jQuery('#balance_type_mst').children(':selected').text()=="&{'BalanceType.in'}" ||
			jQuery('#balance_type_mst').children(':selected').text()=="&{'BalanceType.out'}" ||
			jQuery('#balance_type_mst').children(':selected').text()=="&{'BalanceType.bank_in'}" ||
			jQuery('#balance_type_mst').children(':selected').text()=="&{'BalanceType.bank_out'}"
			) {
		jQuery('#handling_mst_lbl').removeAttr("disabled");
		jQuery('#handling_mst').removeAttr("disabled");
		jQuery('#debit_date_lbl').removeAttr("disabled");
		jQuery('#debit_date').removeAttr("disabled");
	} else {
		jQuery('#handling_mst_lbl').attr("disabled", "disabled");
		jQuery('#handling_mst').attr("disabled", "disabled");
		jQuery('#debit_date_lbl').attr("disabled", "disabled");
		jQuery('#debit_date').attr("disabled", "disabled");
		jQuery('#debit_date').val('');
	}
});
//起動時の「引落日」の入力可・不可
jQuery(document).ready(function() {
	//「取扱(実際)」が現金以外の時は「引落日」は選択可能
	if(jQuery('#handling_mst').children(':selected').text()=="&{'HandlingType.cash'}") {
		jQuery('#debit_date_lbl').attr("disabled", "disabled");
		jQuery('#debit_date').attr("disabled", "disabled");
	} else {
		jQuery('#debit_date_lbl').removeAttr("disabled");
		jQuery('#debit_date').removeAttr("disabled");
	}
});
//「収支種類」・「取扱(My貯金)」の選択変更時の「項目」の入力可・不可と選択リストの調整
jQuery(document).ready(function(){
	jQuery('#balance_type_mst, #ideal_deposit_mst').change(function(){
		jQuery('#item_mst').empty();
		//「収支種類」が収入・支出で「取扱(My貯金)」未選択時は「項目」は選択可能
		if((jQuery('#balance_type_mst').children(':selected').text()=="&{'BalanceType.in'}" ||
				jQuery('#balance_type_mst').children(':selected').text()=="&{'BalanceType.out'}") &&
				jQuery('#ideal_deposit_mst').children(':selected').text()=="&{'views.common.combo.notrequired'}"
				) {
			jQuery('#item_mst_lbl').removeAttr("disabled");
			jQuery('#item_mst').removeAttr("disabled");
			jQuery.each(subcategoryItem[jQuery('#balance_type_mst').val()],function(key,value){
				jQuery('#item_mst').append("<option value='"+value["key"]+"'>"+value["value"]+"</option>");
			});
		} else {
			jQuery('#item_mst_lbl').attr("disabled", "disabled");
			jQuery('#item_mst').attr("disabled", "disabled");
		}
	});
});
//「収支種類」の選択変更時の「取扱(実際)」の入力可・不可と選択リストの調整
jQuery(document).ready(function(){
	jQuery('#balance_type_mst').change(function(){
		jQuery('#handling_mst').empty();
		//「収支種類」が収入・支出・口座預入・口座引出の時は「取扱(実際)」は選択可能
		if(jQuery('#balance_type_mst').children(':selected').text()=="&{'BalanceType.in'}" ||
				jQuery('#balance_type_mst').children(':selected').text()=="&{'BalanceType.out'}" ||
				jQuery('#balance_type_mst').children(':selected').text()=="&{'BalanceType.bank_in'}" ||
				jQuery('#balance_type_mst').children(':selected').text()=="&{'BalanceType.bank_out'}"
				) {
			jQuery('#handling_mst_lbl').removeAttr("disabled");
			jQuery('#handling_mst').removeAttr("disabled");
			jQuery.each(subcategoryHandling[jQuery('#balance_type_mst').val()],function(key,value){
				jQuery('#handling_mst').append("<option value='"+value["key"]+"'>"+value["value"]+"</option>");
			});
		} else {
			jQuery('#handling_mst_lbl').attr("disabled", "disabled");
			jQuery('#handling_mst').attr("disabled", "disabled");
		}
	});
});
//「口座預入」・「口座引出」の時は「取扱(My貯金)」は入力不可
jQuery(document).ready(function(){
	jQuery('#balance_type_mst').change(function(){
		if(jQuery('#balance_type_mst').children(':selected').text()=="&{'BalanceType.bank_in'}" ||
				jQuery('#balance_type_mst').children(':selected').text()=="&{'BalanceType.bank_out'}") {
			jQuery('#ideal_deposit_mst').val('0');  // (なし) を選択
			jQuery('#ideal_deposit_mst_lbl').attr("disabled", "disabled");
			jQuery('#ideal_deposit_mst').attr("disabled", "disabled");
		} else {
			jQuery('#ideal_deposit_mst_lbl').removeAttr("disabled");
			jQuery('#ideal_deposit_mst').removeAttr("disabled");
		}
	});
});
//「収支種類」・「支払日」・「取扱(実際)」の選択変更時の「引落日」の入力可・不可とデフォルト日付の調整
jQuery(document).ready(function(){
	jQuery('#balance_type_mst, #handling_mst, #payment_date').change(function(){
		var sDate = jQuery('#payment_date').val().substr(0,10);
		//「取扱(実際)」が現金の時は「引落日」は「支払日」と同じ日とし、選択不可
		if(jQuery('#handling_mst').children(':selected').text()=="&{'HandlingType.cash'}") {
			jQuery('#debit_date_lbl').attr("disabled", "disabled");
			jQuery('#debit_date').attr("disabled", "disabled");
			jQuery('#debit_date').val(ckDate(sDate)==true ? sDate : '');
		//「取扱(実際)」が現金以外の時
		} else {
			//「収支種類」がMy貯金預入・My貯金引出の時は「引落日」は選択不可
			if(jQuery('#balance_type_mst').children(':selected').text()=="&{'BalanceType.ideal_deposit_in'}" ||
					jQuery('#balance_type_mst').children(':selected').text()=="&{'BalanceType.ideal_deposit_out'}"
					) {
				jQuery('#debit_date_lbl').attr("disabled", "disabled");
				jQuery('#debit_date').attr("disabled", "disabled");
				jQuery('#debit_date').val(ckDate(sDate)==true ? sDate : '');
				
			//「収支種類」が上記以外の時は「引落日」は選択可能で、デフォルト日付を表示
			} else {
				jQuery('#debit_date_lbl').removeAttr("disabled");
				jQuery('#debit_date').removeAttr("disabled");
				#{list items:models.HandlingMst.find("ha_user = ${haUser.id}").fetch(), as:'handling'}
				  if("${handling?.handling_name}"==jQuery('#handling_mst').children(':selected').text()) {
					//支払日が正しく入っている時
//					var sDate = jQuery('#payment_date').val().substr(0,10);
					if(ckDate(sDate)==true) {
						//「取扱(実際)」がクレジットカードの場合
						if("${handling?.handling_type_mst?.handling_type_name}"=="&{'HandlingType.creca'}") {
							var dateFormat = new DateFormat("yyyy/MM/dd");
							var vYear = sDate.substr(0, 4) - 0;
							var vMonth = sDate.substr(5, 2) - 1;
							var vDay = sDate.substr(8, 2) - 0;
							var dPaymentDate = new Date(sDate.substr(0, 4), sDate.substr(5, 2)-1, sDate.substr(8, 2));
							var rDate = fDebitDate(dPaymentDate,"${handling?.cutoff_day}","${handling?.debit_month}","${handling?.debit_day}");
							jQuery('#debit_date').val(dateFormat.format(rDate));
							
						//「取扱(実際)」がクレジットカード以外の場合
						} else {
							//引落日に支払日をセット
							jQuery('#debit_date').val(sDate);
						}
					}
				  }			
				#{/list}
			}
		}
	});
});
//クレジットカードの引落日算出関数
function fDebitDate(dBasic,cutoffDay,debitMonth,debitDay){
	var dCutoff = new Date;
	var iCutoffMonth = 0;
	//
	if(debitMonth=="&{'DebitMonth.this'}") {
		iCutoffMonth = 0;
	} else if(debitMonth=="&{'DebitMonth.next'}") {
		iCutoffMonth = 1;
	} else if(debitMonth=="&{'DebitMonth.nextTwo'}") {
		iCutoffMonth = 2;
	}
	//引落日算出
	if(dBasic.getDate() <= cutoffDay) {
		dCutoff = new Date(dBasic.getFullYear(), dBasic.getMonth()+iCutoffMonth, debitDay);
	} else {
		dCutoff = new Date(dBasic.getFullYear(), dBasic.getMonth()+iCutoffMonth+1, debitDay);
	}
	return dCutoff;
}

//3桁区切りの数値入力フィールドとして設定
jQuery(function() {
	jQuery('input.numeric').autoNumeric({aPad: false, vMin: '-999999999.99', vMax: '999999999.99'});
});

//金額を3桁区切りに(初期表示)
jQuery(document).ready(function(){
	jQuery('input.numeric').each(function(i) {
		var numStr = addFigure(jQuery(this).val());
		jQuery(this).val(numStr);
	});
});

//文字列を3桁区切りにする関数
function addFigure(str) {
    var num = new String(str).replace(/,|\n| |\t/g, "");
	num = num.replace(/(\d)(?=(\d{3})+$)/g , '$1,');
    return num;
}

/****************************************************************
* 機　能： 入力された値が日付でYYYY/MM/DD形式になっているか調べる
* 引　数： datestr　入力された値
* 戻り値： 正：true　不正：false
****************************************************************/
function ckDate(datestr) {
    // 正規表現による書式チェック
    if(!datestr.match(/^\d{4}\/\d{2}\/\d{2}$/)){
        return false;
    }
    var vYear = datestr.substr(0, 4) - 0;
    var vMonth = datestr.substr(5, 2) - 1; // Javascriptは、0-11で表現
    var vDay = datestr.substr(8, 2) - 0;
    // 月,日の妥当性チェック
    if(vMonth >= 0 && vMonth <= 11 && vDay >= 1 && vDay <= 31){
        var vDt = new Date(vYear, vMonth, vDay);
        if(isNaN(vDt)){
            return false;
        }else if(vDt.getFullYear() == vYear && vDt.getMonth() == vMonth && vDt.getDate() == vDay){
            return true;
        }else{
            return false;
        }
    }else{
        return false;
    }
}
// -->
</script>

#{ifErrors}
    <p class="crudFlash flashError">
        &{'validation.title'}
    </p>
#{/ifErrors}
	    
<div id="crudShow">

	#{ifnot record?.id}
		<h3><span>&{'insupd.add', messages.get('Record')}</span></h3>
	#{/ifnot}
	#{else}
		<h3><span>&{'insupd.edit', messages.get('Record')}</span></h3>
	#{/else}
	
    <div class="objectForm">
	#{form @save_rec(record?.id)}
	 
	    <div class="crudField">
	        #{field 'payment_date'}
	        <label class="fieldName">&{'payment_date'}:</label>
	        <input type="text" id="${field.name}" class="datetimepicker" name="${field.name}" 
	            value="${record?.payment_date?.format('yyyy/MM/dd HH:mm')}" />
	        <span class="error">#{error 'record.payment_date' /}</span>
	        #{/field}
	    </div>
	 
	    <div class="crudField">
	        #{field 'balance_type_mst'}
	        <label class="fieldName">&{'balance_type_mst'}:</label>
			<select id="${field.name}" name="${field.name}" class="re_w150">
				<option value="0"${record?.balance_type_mst ? '' : ' selected'}>&{'views.common.combo.required.long'}</option>
				#{list items:models.BalanceTypeMst.find("order by id").fetch(), as:'bType'}
				<option value="${bType.id}"${record?.balance_type_mst?.id==bType.id ? ' selected' : ''}>${bType.balance_type_name}</option>
				#{/list}
			</select>
	        <span class="error">#{error 'record.balance_type_mst' /}</span>
	        #{/field}
	    </div>
	 	
	    <div class="crudField">
	        #{field 'handling_mst'}
	        <label id="handling_mst_lbl" class="fieldName">&{'handling_mst'}:</label>
			<select id="${field.name}" name="${field.name}" class="re_w150">
				#{list items:models.HandlingMst.find("ha_user = ${haUser.id} and invalidity_flg = false order by handling_type_mst.handling_type_order, order_seq").fetch(), as:'handling'}
				<option value="${handling.id}"${record?.handling_mst?.id==handling.id ? ' selected' : ''}>${handling.handling_name}</option>
				#{/list}
			</select>
	        <span class="error">#{error 'record.handling_mst' /}</span>
	        #{/field}
	    </div>
	 
	    <div class="crudField">
	        #{field 'ideal_deposit_mst'}
	        <label id="ideal_deposit_mst_lbl" class="fieldName">&{'ideal_deposit_mst'}:</label>
			<select id="${field.name}" name="${field.name}" class="re_w150">
				<option value="0"${record?.ideal_deposit_mst ? '' : ' selected'}>&{'views.common.combo.notrequired'}</option>
				#{list items:models.IdealDepositMst.find("ha_user = ${haUser.id} order by id").fetch(), as:'idealDeposit'}
				<option value="${idealDeposit.id}"${record?.ideal_deposit_mst?.id==idealDeposit.id ? ' selected' : ''}>${idealDeposit.ideal_deposit_name}</option>
				#{/list}
			</select>
	        <span class="error">#{error 'record.ideal_deposit_mst' /}</span>
	        #{/field}
	    </div>
	 
	    <div class="crudField">
	        #{field 'item_mst'}
	        <label id="item_mst_lbl" class="fieldName">&{'item_mst'}:</label>
			<select id="${field.name}" name="${field.name}" class="re_w150">
				#{if record?.balance_type_mst?.balance_type_name==messages.get('BalanceType.in') ||
						record?.balance_type_mst?.balance_type_name==messages.get('BalanceType.out')}
					<option value="0"${record?.item_mst ? '' : ' selected'}>&{'views.common.combo.required.long'}</option>
					#{list items:models.BalanceTypeMst.find("balance_type_name = '" + record?.balance_type_mst?.balance_type_name + "'").first(), as:'bType'}
					#{list items:models.ItemMst.find("ha_user = ${haUser.id} and balance_type_mst = " + bType.id + " order by id").fetch(), as:'item'}
					<option value="${item.id}"${record?.item_mst?.id==item.id ? ' selected' : ''}>${item.item_name}</option>
					#{/list}
					#{/list}
				#{/if}
			</select>
	        <span class="error">#{error 'record.item_mst' /}</span>
	        #{/field}
	    </div>
	
	    <div class="crudField">
	        #{field 'amount'}
	        <label class="fieldName">&{'amount'}:</label>
	        <input type="text" name="${field.name}" class="numeric" 
	            value="${record?.amount}" />
	        <span class="error">#{error 'record.amount' /}</span>
	        #{/field}
	    </div>
	 
	    <div class="crudField">
	        #{field 'debit_date'}
	        <label id="debit_date_lbl" class="fieldName">&{'debit_date'}:</label>
	        <input type="text" id="${field.name}" class="datepicker" name="${field.name}" 
	            value="${record?.debit_date?.format('yyyy/MM/dd')}" />
	        <span class="error">#{error 'record.debit_date' /}</span>
	        #{/field}
	    </div>
	 
	    <div class="crudField">
	        #{field 'content'}
	        <label class="fieldName">&{'content'}:</label>
	        <input type="text" name="${field.name}" 
	            value="${record?.content}" />
	        <span class="error">#{error 'record.content' /}</span>
	        #{/field}
	    </div>
	 
	    <div class="crudField">
	        #{field 'store'}
	        <label class="fieldName">&{'store'}:</label>
	        <input type="text" name="${field.name}" 
	            value="${record?.store}" />
	        <span class="error">#{error 'record.store' /}</span>
	        #{/field}
	    </div>
	
	    <div class="crudField">
	        #{field 'remarks'}
	        <label class="fieldName">&{'remarks'}:</label>
	        <textarea name="${field.name}">${record?.remarks}</textarea>
	        <span class="error">#{error 'record.remarks' /}</span>
	        #{/field}
	    </div>
	 
	    <div class="crudField">
	        #{field 'secret_remarks'}
	        <label class="fieldName">&{'secret_remarks'}:</label>
	        <textarea name="${field.name}">${record?.secret_remarks}</textarea>
	        <span class="error">#{error 'record.secret_remarks' /}</span>
	        #{/field}
	    </div>
	 
	    <div class="crudField">
	        #{field 'secret_rec_flg'}
	        <label class="fieldName">&{'secret_rec_flg'}:</label>
	        <input type="checkbox" name="${field.name}"
	            ${record?.secret_rec_flg ? 'checked' : ''} />
	        <span class="error">#{error 'record.secret_rec_flg' /}</span>
	        #{/field}
	    </div>
		
	    <div class="crudField">
	        <input type="submit" value="&{'insupd.save'}" />
	    </div>
	    
	#{/form}
	</div>
	
	#{if record?.id}
		#{form @del_rec(record?.id)}
		    <p class="crudDelete">
	        	<input type="submit" value="&{'insupd.delete', messages.get('Record')}" id="cnf_del" />
		    </p>
		#{/form}
	#{/if}

</div>
