<script type="text/javascript" src="@{'/public/javascripts/jquery.datepicker.js'}" ></script>

#{include 'subCategory.html' /}

<script type="text/javascript">
<!-- 
/**
 * 収支データ更新用ダイアログ
 */
var preBType,
	STR80 = "90%",
	STR100 = "100%",
	STR150 = "150%";
function openDialogFrmUpdRec(strType, dfurRec, lngMstId) {
	jQuery(function() {
		var dfurPayDate = jQuery("#dfurPayDate"),
			dfurBType = jQuery("#dfurBType"),
			dfurHdlg = jQuery('#dfurHdlg'),
			dfurPrlt = jQuery('#dfurPrlt'),
			dfurItem = jQuery('#dfurItem'),
			dfurAmnt = jQuery('#dfurAmnt'),
			dfurDebDate = jQuery('#dfurDebDate'),
			dfurCntnt = jQuery('#dfurCntnt'),
			dfurStore = jQuery('#dfurStore'),
			dfurRmrks = jQuery('#dfurRmrks'),
			title = dfurRec.id===null ? "&{'views.dialogFrmUpdRec.title.ins'}" : strType+"&{'views.dialogFrmUpdRec.title.upd'}",
			buttons = {},
			allFields = jQuery([]).add(dfurPayDate.children('input')),
			tips = jQuery(".validateTips"),
			intRslt = 0;
		
		/* 要素の初期化 */
		initElem(dfurRec);
		
		preBType = dfurBType.children('select').val();
	
		allFields.removeClass("ui-state-error");
		tips
			.css('padding', '0')
			.css('margin-bottom', '0')
			.text("");
		
		buttons["&{'insupd.save'}"] = function() {
			var bValid = true;
			allFields.removeClass("ui-state-error");
			bValid = bValid && checkRequired(dfurPayDate.children('input'), "&{'payment_date'}");
			bValid = bValid && checkRequired(dfurAmnt.children('input'), "&{'amount'}");
			
			
			if (bValid) {
				intRslt = 1;
				var sel;
				
				dfurRec.payment_date = dfurPayDate.children('input').val();
				sel = dfurBType.children('select').val();
				dfurRec.balance_type_mst_id = (sel==null || sel=="") ? undefined : parseInt(sel);
				sel = dfurHdlg.children('select').val();
				dfurRec.handling_mst_id = (sel==null || sel=="") ? undefined : parseInt(sel);
				sel = dfurPrlt.children('select').val();
				dfurRec.parllet_mst_id = (sel==null || sel=="") ? undefined : parseInt(sel);
				sel = dfurItem.children('select').val();
				dfurRec.item_mst_id = (sel==null || sel=="") ? undefined : parseInt(sel);
				dfurRec.amount = parseInt(dfurAmnt.children('input').val());
				dfurRec.debit_date = dfurDebDate.children('input').val();
				dfurRec.content = dfurCntnt.children('input').val();
				dfurRec.store = dfurStore.children('input').val();
				dfurRec.remarks = dfurRmrks.children('textarea').val();
				
				jQuery(this).dialog("close");
			}
		}
		buttons["&{'views.common.btn.cancel'}"] = function() {
			jQuery(this).dialog("close");
		}
		function updateTips(t) {
			tips
				.css('padding', '0.3em')
				.css('margin-bottom', '1em')
				.text(t)
				.addClass("ui-state-highlight");
			setTimeout(function() {
				tips.removeClass("ui-state-highlight", 1500);
			}, 500);
		}
		function checkRequired(o, n) {
			if (o.val()==="") {
				o.addClass("ui-state-error");
				updateTips(n + " &{'views.login.fbLogin.err.required'}");
				return false;
			} else {
				return true;
			}
		}
		function errValidateTable(o, s) {
			o.addClass("ui-state-error");
			updateTips(s);
		}
		function initElem(dfurRec) {
			chgElem(dfurPayDate, dfurRec.payment_date, 'input', null);
			chgElem(dfurBType, dfurRec.balance_type_mst_id, 'select', dfurPayDate);
			chgElem(dfurHdlg, dfurRec.handling_mst_id, 'select', dfurBType);
			chgElem(dfurPrlt, dfurRec.parllet_mst_id, 'select', dfurHdlg);
			chgElem(dfurItem, dfurRec.item_mst_id, 'select', dfurPrlt);
			chgElem(dfurAmnt, dfurRec.amount, 'input', dfurItem);
			chgElem(dfurDebDate, dfurRec.debit_date, 'input', dfurAmnt);
			chgElem(dfurCntnt, dfurRec.content, 'input', dfurDebDate);
			chgElem(dfurStore, dfurRec.store, 'input', dfurCntnt);
			chgElem(dfurRmrks, dfurRec.remarks, 'textarea', dfurStore);
			
			dfurBType.children('select').change();
			
			dfurItem.children('label').css('clear', 'both');
			dfurStore.children('label').css('clear', 'both');
		}
		
		
		/* 「収支種類」の選択変更イベント */
		dfurBType.children('select').change(function(e){
			var jText = jQuery(this).children(':selected').text(),
				jVal = jQuery(this).val();
			
			//「収支種類」が収入・支出で、「項目」のリストがゼロの時
			if((jText==="&{'BalanceType.in'}" ||
				jText==="&{'BalanceType.out'}") &&
					jQuery(subCatItem[jVal]).length===0) {
				e.preventDefault();
				if(jText==="&{'BalanceType.in'}")
					//項目（収入）作成用ダイアログ
					openDialogConfirm("&{'views.dialogConfirm.case.itemIn'}", jText);
				if(jText==="&{'BalanceType.out'}")
					//項目（支出）作成用ダイアログ
					openDialogConfirm("&{'views.dialogConfirm.case.itemOut'}", jText);
				
			//「収支種類」が口座預入・口座引出で、「取扱(実際)」のリストがゼロの時
			} else if((jText==="&{'BalanceType.bank_in'}" ||
						jText==="&{'BalanceType.bank_out'}") &&
					jQuery(subCatHdlgSmall[subCatHdlgLarge[jVal]]).length===0) {
				e.preventDefault();
				//口座・電子マネー作成用ダイアログ
				openDialogConfirm("&{'views.dialogConfirm.case.bkem'}", jText);
				
			//「収支種類」がMy貯金預入・My貯金引出で、「取扱(My貯金)」のリストがゼロの時
			} else if((jText==="&{'BalanceType.parllet_in'}" ||
						jText==="&{'BalanceType.parllet_out'}") &&
					jQuery('#parllet_mst').children().length===1) {
				e.preventDefault();
				//My貯金作成用ダイアログ
				openDialogConfirm("&{'views.dialogConfirm.case.ideal'}", jText);
				
			} else {
				//「取扱(実際)」の状態調整
//				conditionAdjust_Handling();
				
				//「取扱(実際)」のリスト再作成
//				remakeList_Handling();
				
				//「取扱(My貯金)」の状態調整
				if (jText==="&{'BalanceType.bank_in'}" ||
						jText==="&{'BalanceType.bank_out'}")
					conditionAdjust_IdealDepo(jQuery('#dfurBType option:selected').text(), dfurRec, dfurPrlt, dfurHdlg);
				
				preBType = jVal;
				
				//「項目」のリスト再作成
				remakeList_Item(jQuery('#dfurBType option:selected').text(), jVal, dfurItem.children('select'));
				
				//「項目」の状態調整
				conditionAdjust_Item(jQuery('#dfurBType option:selected').text(), dfurRec, dfurItem, dfurPrlt);
				
				//「Parllet」の<a>の状態調整
				if (jText==="&{'BalanceType.bank_in'}" ||
						jText==="&{'BalanceType.bank_out'}") {
					dfurPrlt.children('a, label').css('cursor', 'default');
				} else {
					dfurPrlt.children('a, label').css('cursor', 'pointer');
				}
			}
			
			
		});
		/* 「Parllet」の選択変更イベント */
		dfurPrlt.children('select').change(function(e){
			
		});
		
		
		/* クリックで編集（input）*/
		jQuery('.editableInput').mousedown(function(e) {
			if (e.which===1 || e.which===3) {
				e.preventDefault();
	
				//aを非表示
				if (this.nodeName==="A")
					jQuery(this).css('display', 'none');
				if (this.nodeName==="LABEL")
					jQuery(this).next('a').css('display', 'none');
				//inputを表示
				if (jQuery(this).nextAll('input').hasClass('invisible'))
					jQuery(this).nextAll('input').removeClass('invisible');
				jQuery(this).nextAll('input').css('font-size', '70%')
											.css('width', '80px')
											.css('height', '8px')
											.css('float', 'left')
											.css('margin-right', '10px')
											.focus();
			}
		});
		/* クリックで編集（textarea）*/
		jQuery('.editableTextarea').mousedown(function(e) {
			if (e.which===1 || e.which===3) {
				e.preventDefault();
	
				//aを非表示
				if (this.nodeName==="A")
					jQuery(this).css('display', 'none');
				if (this.nodeName==="LABEL")
					jQuery(this).next('a').css('display', 'none');
				//textareaを表示
				if (jQuery(this).nextAll('textarea').hasClass('invisible'))
					jQuery(this).nextAll('textarea').removeClass('invisible');
				jQuery(this).nextAll('textarea').css('font-size', '70%')
												.css('width', '100px')
												.css('height', '30px')
												.css('float', 'left')
												.css('background', 'white')
												.css('margin-right', '10px')
												.focus();
			}
		});
		/* クリックで編集（select）*/
		dfurPrlt.children('a, label').mousedown(function(e) {
			if (e.which===1 || e.which===3) {
				e.preventDefault();
	
				conditionAdjust_IdealDepo(jQuery('#dfurBType option:selected').text(), dfurRec, dfurPrlt, dfurHdlg);
			}
		});
		
		
		jQuery("#dialog-updRec").dialog({
			autoOpen: false,
			resizable: false,
			width:460,
			modal: true,
			title: title,
			buttons: buttons,
			close: function() {
//				dfurRec.payment_date = dfurPayDate.children('input').text();
				//ダイアログクローズ時の処理は呼び出し元で行う
				whenDialogFrmUpdRecClosed(intRslt, dfurRec);
			}
		});
		jQuery("#dialog-updRec").dialog("open");
		
		/* Enterキーでのサブミット防止 */
		jQuery('input[type!="submit"][type!="button"]').keypress(function(e){
			if ((e.which && e.which===13) || (e.keyCode && e.keyCode===13)) {
				return false;
			}else{
				return true;
			}
		});
	});
}
function DfurRec(
		id,
		payment_date,
		balance_type_mst_id,
		handling_mst_id,
		parllet_mst_id,
		item_mst_id,
		amount,
		debit_date,
		content,
		store,
		remarks
		) {
	this.id = id;
	this.payment_date = payment_date;
	this.balance_type_mst_id = balance_type_mst_id;
	this.handling_mst_id = handling_mst_id;
	this.parllet_mst_id = parllet_mst_id;
	this.item_mst_id = item_mst_id;
	this.amount = amount;
	this.debit_date = debit_date;
	this.content = content;
	this.store = store;
	this.remarks = remarks;
}
function DfurFlgVal(flg, val) {
	this.flg = flg;
	this.val = val;
}

/**
	項目毎に表示方法を調整
**/
function chgElem(jqSelector, dfurFlgValCrnt, strInput, jqSelPrev) {
	jqSelector.children(strInput).val(dfurFlgValCrnt.val);
	
	//項目のフラグ有効時
	if (dfurFlgValCrnt.flg) {
		//ラベル前を改行
		jqSelector.children('label').css('float', 'none');
		jqSelector.children('label').css('clear', 'both');
		jqSelector.children('label').css('font-size', STR100);
		//aを非表示
		jqSelector.children('a').css('display', 'none');
		//inputを表示
		if (jqSelector.children(strInput).hasClass('invisible'))
			jqSelector.children(strInput).removeClass('invisible');
		
	//項目のフラグ無効時
	} else {
		//ラベル前を詰める
		jqSelector.children('label').css('float', 'left');
		jqSelector.children('label').css('clear', 'none');
		jqSelector.children('label').css('font-size', STR80);
		//aを表示
		jqSelector.children('a').css('display', 'block');
		//inputを非表示
		jqSelector.children(strInput).addClass('invisible');
	}
	
	//aのテキストをinputに合わせる
	if (strInput==='input' || strInput==='textarea')
		jqSelector.children('a').text(dfurFlgValCrnt.val);
	if (strInput==='select')
		jqSelector.children('a').text(jqSelector.children(strInput).children(':selected').text());
}

/* 「項目」の状態調整 */
function conditionAdjust_Item(strBTypeText, dfurRec, dfurItem, dfurPrlt) {
	//「収支種類」が収入・支出の時は「項目」は選択可能
	dfurRec.item_mst_id.flg = false;
	if(strBTypeText==="&{'BalanceType.in'}" ||
			strBTypeText==="&{'BalanceType.out'}"
			)
		dfurRec.item_mst_id.flg = true;
	chgElem(dfurItem, dfurRec.item_mst_id, 'select', dfurPrlt);
}

/* 「Parllet」の状態調整 */
function conditionAdjust_IdealDepo(strBTypeText, dfurRec, dfurPrlt, dfurHdlg) {
	//「収支種類」が収入・支出の時は「Parllet」は選択可能
	dfurRec.parllet_mst_id.flg = false;
	if(strBTypeText==="&{'BalanceType.in'}" ||
			strBTypeText==="&{'BalanceType.out'}"
			)
		dfurRec.parllet_mst_id.flg = true;
	chgElem(dfurPrlt, dfurRec.parllet_mst_id, 'select', dfurHdlg);
}

/* 「項目」のリスト再作成 */
function remakeList_Item(strBTypeText, strBTypeVal, jqItem) {
	jqItem.empty();
	//「収支種類」が収入・支出の時は「項目」のリストを再作成
	if (strBTypeText==="&{'BalanceType.in'}" ||
		strBTypeText==="&{'BalanceType.out'}"
			)
		jQuery.each(subCatItem[strBTypeVal],function(key,value){
			jqItem.append("<option value='"+value["key"]+"'>"+value["value"]+"</option>");
		});
}
// -->
</script>

#{include 'dialogConfirm.html' /}
<script type="text/javascript">
<!--
/* dialogConfirmを閉じた時の動作は呼び出し元で行う */
function whenDialogConfirmClosed(intRslt) {
	switch (intRslt) {
		case 0:
			jQuery('#dfurBType').children('select').val(preBType).change().focus();
			break;
		case 1:
			//口座更新フォームを開く
			openDialogFrmUpdMstDfur("&{'views.config.cf_bank'}");
			break;
		case 2:
			//電子マネー更新フォームを開く
			openDialogFrmUpdMstDfur("&{'views.config.cf_emoney'}");
			break;
		case 3:
			//My貯金更新フォームを開く
			openDialogFrmUpdMstDfur("&{'views.config.cf_idealdepo'}");
			break;
		case 4:
			//項目（収入）更新フォームを開く
			openDialogFrmUpdMstDfur("&{'views.dialogConfirm.case.itemIn'}");
			break;
		case 5:
			//項目（支出）更新フォームを開く
			openDialogFrmUpdMstDfur("&{'views.dialogConfirm.case.itemOut'}");
			break;
		default:
			alert("dialogConfirm return value error");
	}
}
function openDialogFrmUpdMstDfur(strMst) {
	openDialogFrmUpdMst(strMst, "&{'views.name.dlgFrmUpdRec'}");
}
// -->
</script>


#{if icldDlgFrmUpdMst!=1}
	#{include 'dialogFrmUpdMst.html' /}
#{/if}
<script type="text/javascript">
<!--
/* dialogFrmUpdMstを閉じた時の動作は呼び出し元で行う */
function whenDialogFrmUpdMstClosedDfur(intRslt, strType, nameVal, zeroHddnChkd) {
	var strErrMsg;
	if(strType==="&{'views.config.cf_bank'}" || strType==="&{'views.config.cf_emoney'}")
		strErrMsg = "Common.updateHdlg";
	if(strType==="&{'views.config.cf_idealdepo'}")
		strErrMsg = "Common.updatePrlt";
	if(strType==="&{'views.dialogConfirm.case.itemIn'}" || strType==="&{'views.dialogConfirm.case.itemOut'}")
		strErrMsg = "Common.makeItem";
	switch (intRslt) {
		case 0:
			whenDialogConfirmClosed(0);
			break;
		case 1:
			var jqxhrMkMst;
			if(strType==="&{'views.config.cf_bank'}" || strType==="&{'views.config.cf_emoney'}") {
				jqxhrMkMst = jQuery.post('@{Common.updateHdlg}', {strType: strType, strName: nameVal, bolZeroHddn: zeroHddnChkd});
			}
			if(strType==="&{'views.config.cf_idealdepo'}") {
				jqxhrMkMst = jQuery.post('@{Common.updatePrlt}', {strName: nameVal, bolZeroHddn: zeroHddnChkd});
			}
			if(strType==="&{'views.dialogConfirm.case.itemIn'}" || strType==="&{'views.dialogConfirm.case.itemOut'}") {
				var strBalanceType;
				if(strType==="&{'views.dialogConfirm.case.itemIn'}")
					strBalanceType = "&{'BalanceType.in'}";
				if(strType==="&{'views.dialogConfirm.case.itemOut'}")
					strBalanceType = "&{'BalanceType.out'}";
				jqxhrMkMst = jQuery.post('@{Common.makeItem}', {strBalanceType: strBalanceType, strName: nameVal});
			}
			jqxhrMkMst
			.done(function(z) {
				switch (z.intRslt) {
					case 0:
						var dfurBTypeSel = jQuery('#dfurBType').children('select');
						if(strType==="&{'views.config.cf_bank'}" || strType==="&{'views.config.cf_emoney'}") {
							//作成した口座・電子マネーを取扱(実際)のリストに追加し、収支種類の選択変更イベントを再実行
							var newBank = {"key":z.hlMst.id, "value":z.hlMst.handling_name}
							subCatHdlgSmall["ALL"].push(newBank);
							subCatHdlgSmall["BANK"].push(newBank);
							dfurBTypeSel.change();
						}
						if(strType==="&{'views.config.cf_idealdepo'}") {
							//作成したMy貯金を取扱(My貯金)のリストに追加し、収支種類の選択変更イベントを再実行
							jQuery('#parllet_mst').append("<option value='"+z.idMst.id+"' selected>"+z.idMst.parllet_name+"</option>");
							dfurBTypeSel.change();
						}
						if(strType==="&{'views.dialogConfirm.case.itemIn'}" || strType==="&{'views.dialogConfirm.case.itemOut'}") {
							//作成した項目をリストに追加し、収支種類の選択変更イベントを再実行
							var newItem = {"key":z.itMst.id, "value":z.itMst.item_name}
							subCatItem[dfurBTypeSel.val()].push(newItem);
							dfurBTypeSel.change();
						}
						break;
					case 99:
						alert(z.strErr);
						whenDialogConfirmClosed(0);
						break;
					default:
						strErrMsg += " result Error";
						alert(strErrMsg);
						whenDialogConfirmClosed(0);
				}
			})
			.fail(function() {
				strErrMsg += " Failed";
				alert(strErrMsg);
				whenDialogConfirmClosed(0);
			});
			break;
		default:
			alert("dialogFrmUpdMst return value error");
	}
}
// -->
</script>

<div id="dialog-updRec" class="invisible">
	<div class="validateTips"></div>
	<form>
	<fieldset>
		
		<span id="dfurPayDate" class="dfurElem">
			<label>&{'payment_date'}:</label>
			<a class="ui-widget-content"></a>
			<input type="text" class="datepicker text ui-widget-content invisible" 
				value=""/>
			<div></div>
		</span>
		
		<span id="dfurBType" class="dfurElem">
			<label>&{'balance_type_mst'}:</label>
			<a class="ui-widget-content"></a>
			<select>
				#{list items:models.BalanceTypeMst.find("balance_type_name != ? and balance_type_name != ? order by id", messages.get('BalanceType.parllet_in'), messages.get('BalanceType.parllet_out')).fetch(), as:'bType'}
				<option value="${bType.id}">${bType.balance_type_name}</option>
				#{/list}
			</select>
		</span>
		
		<span id="dfurHdlg" class="dfurElem">
			<label>&{'handling_mst'}:</label>
			<a class="ui-widget-content"></a>
			<select>
				#{list items:models.HandlingMst.find("ha_user = ${haUser.id} and (invalidity_flg = false) order by handling_type_mst.handling_type_order, order_seq").fetch(), as:'handling'}
				<option value="${handling.id}">${handling.handling_name}</option>
				#{/list}
			</select>
		</span>
		
		<span id="dfurPrlt" class="dfurElem">
			<label>&{'parllet_mst'}:</label>
			<a class="ui-widget-content"></a>
			<select>
				<option value=""${record?.parllet_mst ? '' : ' selected'}>&{'views.common.combo.notrequired'}</option>
				%{prtCnt = models.ParlletMst.count("ha_user = ?", haUser)}%
				#{if prtCnt==0}
					<option value="new">&{'views.common.combo.new'}</option>
				#{/if}
				#{else}
					#{list items:models.ParlletMst.find("ha_user = ${haUser.id} order by id").fetch(), as:'idealDeposit'}
						<option value="${idealDeposit.id}">${idealDeposit.parllet_name}</option>
					#{/list}
				#{/else}
				
			</select>
		</span>
		
		<span id="dfurItem" class="dfurElem">
			<label>&{'item_mst'}:</label>
			<a class="ui-widget-content"></a>
			<select>
				%{
					bType
					bTypeName
					if(vlBalanceTypeId) {
						bType = models.BalanceTypeMst.find("byId", vlBalanceTypeId).first()
						bTypeName = bType.balance_type_name 
					}
				}%
				#{if bTypeName==messages.get('BalanceType.in') ||
						bTypeName==messages.get('BalanceType.out')}
					#{list items:models.ItemMst.find("ha_user = ${haUser.id} and balance_type_mst = " + bType.id + " order by id").fetch(), as:'item'}
					<option value="${item.id}">${item.item_name}</option>
					#{/list}
				#{/if}
			</select>
		</span>
		
		<span id="dfurAmnt" class="dfurElem">
			<label>&{'amount'}:</label>
			<a class="ui-widget-content"></a>
			<input type="text" class="numeric text ui-widget-content" 
				value="" />
		</span>
		
		<span id="dfurDebDate" class="dfurElem">
			<label>&{'debit_date'}:</label>
			<a class="ui-widget-content"></a>
			<input type="text" class="datepicker text ui-widget-content" 
				value="" />
		</span>

		<span id="dfurCntnt" class="dfurElem">
			<label class="editableInput">&{'content'}:</label>
			<a class="ui-widget-content editableInput"></a>
			<input type="text" class="text ui-widget-content" 
				value="" />
		</span>

		<span id="dfurStore" class="dfurElem">
			<label class="editableInput">&{'store'}:</label>
			<a class="ui-widget-content editableInput"></a>
			<input type="text" class="text ui-widget-content" 
				value="" />
		</span>
		
		<span id="dfurRmrks" class="dfurElem">
			<label class="editableTextarea">&{'remarks'}:</label>
			<a class="ui-widget-content editableTextarea"></a>
			<textarea class="ui-widget-content"></textarea>
		</span>
	</fieldset>
	</form>
</div>  <!-- dialog-updRec -->

